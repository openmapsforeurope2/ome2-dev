# Edge-matching of the AU (Administrative units) theme

## Objective
National administrative units have been provided by a country to the OME2 project. If neighbouring countries had also provided data, the OME2 project may have calculated technical international boundaries, based on the data provided by neighbouring countries, which are slightly different from the versions provided by each country. As a result, national administrative units are no longer consistent with the technical boundaries used in OME2.
The objective is to align national administrative units at all levels with the international boundaries agreed upon for OME2.

This will be done in two steps:
- Step 1: administrative units at the lowest level are aligned with the international boundaries, using the au_matching tool.
- Step 2: administrative units from upper levels are recreated by merging lower level units (correctly aligned thanks to step 1), using the au_merging tool. 

## Pre-requisites:
- The country's national data has been converted to the OME2 data model and integrated in the central database.
- Technical international boundaries have been set up with the neigbouring countries.

## Step 1: edge-match administrative units at the lowest level
This step needs to be performed on each country's lowest administrative level. The table below indicates, for each country, the lowest administrative level provided. The distance column indicates which distance is used to extract administrative units along boundaries (see below).

| country_code | country                        | distance | lowest_level | 
|--------------|--------------------------------|----------|--------------|
| ad           | Andorra                        | 1000     | 1            |
| at           | Austria                        | 1000     | 5            |
| be           | Belgium                        | 1000     | 5            |
| ch           | Switzerland                    | 1000     | 4            |
| cz           | Czech Republic                 | 1000     | 4            |
| dk           | Denmark                        | 1000     | 3            |
| es           | Spain                          | 1000     | 4            |
| fi           | Finland                        | 1000     | 5            |
| fr           | France                         | 1000     | 6            |
| li           | Liechtenstein                  | 1000     | 2            |
| lu           | Luxembourg                     | 1000     | 3            |
| nl           | The Netherlands                | 1000     | 3            |

#### 1) Extract objects around a country's boundaries for matching
The process is launched only on administratives units along international boundaries. It can be launched on all the country's international boundaries at once, or on a single boundary.
To extract the relevant administrative units, the border_extract tool from the data-tools repository is used.

Generic command line to extract administrative units along all the country <country_code>'s international boundaries:
```
python3 script/border_extract.py -c conf.json -T au -t administrative_unit_area_<level> -d <distance> <country_code> '#'
```
Example of an extraction for country <country_code> along its international boundary with <country_code_neighbour>:
```
python3 script/border_extraction.py -c conf.json -T au -t administrative_unit_area_<level> -b <country_code_neighbour> -d <distance> <country_code>
```

<u>Belgium:</u>
Example of an extraction around boundaries with several neighbouring countries: the first line extracts units along the be#nl boundary. In the next lines, the "-n" option indicates that the selection has to be added to the existing selection.
```
python3 script/border_extraction.py -c conf.json -T au -t administrative_unit_area_5 -b nl -d 1000 be
python3 script/border_extraction.py -c conf.json -T au -t administrative_unit_area_5 -b de -d 1000 -n be
python3 script/border_extraction.py -c conf.json -T au -t administrative_unit_area_5 -b lu -d 1000 -n be
```

### 2) Matching

```
bin/au_matching --c data/config/epg_parameters.ini --t <working_schema>.administrative_unit_area_<highest_level>_w --cc <country_code>
```

### 3) Integrate modifications in the main table and working history (wh) table
Before running the integrate, check in the log file whether invalid polygons have been generated by the matching process. If there are some, correct them in QGIS.

```
python3 script/integrate.py -c conf.json -T au -t administrative_unit_area_<highest_level> -s 30
```

## Step 2: edge-match administrative units at all other levels
Upper level administrative units are recreated by merging AUs at a lower level, using the [au_merging](https://github.com/openmapsforeurope2/au_merging) tool on each level successively. 

Please note that the last complete level should be used as reference for merging. For instance, in France, level 5 does not cover the whole territory. Therefore, au.administrative_unit_area_4 will be recreated using au.administrative_unit_area_6 as reference:
<pre>ome2_au_merging --c path/to/config/epg_parameters_merging_ng.ini --s au_administrative_unit_area_6 --t administrative_unit_area_4_w --cc fr</pre>

### 1) Extract objects around a country's boundaries
```
python3 script/border_extract.py -c conf.json -T au -t administrative_unit_area_<n> -d <distance> <country_code> '#'
```

### 2) Merging
```
bin/au_merging --c data/config/epg_parameters.ini --s <administrative_schema>.administrative_unit_area_<n+1> --t <working_schema>.administrative_unit_area_<n>_w --cc <country_code>
```

### 3)  Integrate modifications in the main table and working history (wh) table
Before running the integrate, check in the log file whether invalid polygons have been generated by the matching process. If there are some, correct them in QGIS.
```
python3 script/integrate.py -c conf.json -T au -t administrative_unit_area_<n> -s 30
```


2. Administrative_hierarchy table
The administrative_hierarchy table is a table without geometry which describes the administrative system of each country. This table is an extract of EuroBoundaryMaps' EBM_ISN table for the countries included in the HVLSP.
When a new country is added to the HVLSP, the relevant rows need to be retrieved from EBM_ISN and integrated into au.administrative_hierarchy.
This is currently done with an FME workbench: AU_manage_administrative_hierarchy.fmw The path to the latest EBM file gdb (locally on the user's computer), the connection information to the HVLSP database and a list of countries to integrate need to be provided.
WARNING:
in the final infrastructure, it will probably not be possible to connect FME directly to the HVLSP database.
this workbench does not handle updates, it only adds rows to the administrative_hierarchy table but does not update existing rows if the processed country had already been included before.
Therefore, a more permanent solution needs to be determined: cf.issue #16
